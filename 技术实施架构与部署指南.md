# 技术实施架构与部署指南

## 1. 系统概览
本项目是一个基于 React/Vite 构建的本地 AI 生成界面 ("Infravision")，它纯粹地与本地 **ComfyUI** 实例进行交互。

- **前端**: React (Vite, TypeScript), TailwindCSS.
- **后端/推理**: 本地 ComfyUI API (WebSocket + HTTP).
- **通信**: 使用标准 HTTP fetch 进行上传/排队，使用 WebSocket 监听状态。

## 2. 关键配置与前提条件

为了在通过新环境中成功复现此应用，请严格遵循以下配置步骤。

### A. ComfyUI 配置 (至关重要)
前端运行的源（例如 `localhost:5173`）与 ComfyUI（`127.0.0.1:8188`）不同。

**1. 开启 CORS (跨域资源共享)**
您 **必须** 使用 `--enable-cors-header` 标志启动 ComfyUI。如果没有这个，前端将因 `403 Forbidden` 错误而无法连接。

*   **命令行启动:**
    ```bash
    python main.py --enable-cors-header *
    ```
*   **Bat 脚本启动 (Windows):**
    编辑您的 `.bat` 启动脚本，在末尾追加参数：
    ```batch
    .\python_embeded\python.exe -s ComfyUI\main.py --windows-standalone-build --enable-cors-header *
    ```

**2. 模型依赖**
代码库 (`workflowTemplate.ts`) 也就是工作流模板硬编码了特定的模型文件名。您必须重命名本地模型以匹配这些名称，或者更新代码。

*   **大模型 Checkpoint (SDXL):** `juggernautXL_v9Rundiffusionphoto2.safetensors`
*   **ControlNet:** `Union_sdxl_promaxl.safetensors`

*注意：如果使用不同的模型，请更新 `services/workflowTemplate.ts` 第 5 行 (checkpoint) 和第 60 行 (controlnet)。*

### B. 前端配置
确保已安装 Node.js (v18+)。

1.  **安装依赖:**
    ```bash
    npm install
    ```
2.  **环境变量:**
    用于连接 ComfyUI 的 API 地址硬编码在 `services/comfyService.ts` 中。
    - 默认值: `http://127.0.0.1:8188`
    - *如有需要请直接修改该文件中的 COMFY_API_URL。*

## 3. 工作流集成架构

应用程序在客户端动态构建 ComfyUI 工作流。

### 关键逻辑文件
*   **`services/workflowTemplate.ts`**: 包含基于 JSON 的节点图模板。
    *   **关键修复记录**: 确保 `SaveImage` 节点 (ID 9) 具有指向 VAE Decode 节点的有效输入连接 `images: ["8", 0]`。缺少此项会导致 “Required input is missing” 错误。
*   **`services/comfyService.ts`**: 处理图像上传、工作流参数注入（种子、提示词、尺寸）和 WebSocket 执行监控。

### 数据流逻辑
1.  **用户输入**: 用户选择风格，输入文本，上传参考图像。
2.  **预处理**: 图像文件上传到 ComfyUI `/upload/image` 接口。
3.  **图构建**:
    - 加载 `WORKFLOW_TEMPLATE` 模板。
    - 注入提示词 Prompt (`inputs.text`)。
    - 注入种子 Seed (`inputs.seed`)。
    - 注入 ControlNet 图像 (`inputs.image` -> 上传的文件名)。
4.  **执行**: 构建好的 JSON 图发送到 `/prompt` 接口。
5.  **检索**: 前端监听 `executed` WebSocket 事件，解析结果，并通过 `/view` 接口获取最终图片。

## 4. 常见故障排查

| 问题 | 症状 | 解决方案 |
| :--- | :--- | :--- |
| **连接失败** | "Connection refused" 或 403 Forbidden | 检查 ComfyUI 是否正在运行。**核实启动参数是否包含 `--enable-cors-header *`。** |
| **工作流错误** | "Required input is missing: images" | 检查 `workflowTemplate.ts`。确保 `SaveImage` 节点的输入已连接到 `VAEDecode` 的输出。 |
| **模型缺失** | ComfyUI 控制台错误: "Value not in list..." | `workflowTemplate.ts` 中的文件名与 `ComfyUI/models/...` 实际文件名不匹配。请更新代码或下载对应模型。 |
| **生成卡住** | WebSocket 已连接但无图像返回 | 检查 ComfyUI 服务端控制台是否有服务端错误（如显存不足 OOM，或缺少节点插件）。 |

## 5. 部署前核对清单
- [ ] ComfyUI 已安装并运行。
- [ ] 启动参数已包含 `--enable-cors-header *`。
- [ ] 必需的 Checkpoint 和 ControlNet 模型已放置在 ComfyUI models 文件夹中。
- [ ] `workflowTemplate.ts` 中的模型名与本地一致。
- [ ] 确保前端服务已启动 (`npm run dev`)。
